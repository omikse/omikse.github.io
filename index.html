<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>Tutor Maturalny AI (2025 + Zasady Oceniania)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Lora:ital,wght@0,400;0,600;1,400&family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .font-serif { font-family: 'Lora', serif; }
        
        .loader {
            border: 2px solid #e0e7ff;
            border-top: 2px solid #4f46e5;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Table Styles for Rubrics */
        .markdown-body table { width: 100%; border-collapse: collapse; margin-top: 1rem; margin-bottom: 1rem; font-size: 0.9em; }
        .markdown-body th, .markdown-body td { border: 1px solid #e2e8f0; padding: 0.5rem; text-align: left; }
        .markdown-body th { background-color: #f8fafc; font-weight: 600; }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 flex flex-col min-h-screen">

<!-- Top Navigation Bar -->
<header class="bg-white border-b border-slate-200 sticky top-0 z-50 shadow-sm">
    <div class="max-w-6xl mx-auto px-4 h-16 flex justify-between items-center">
        <!-- Logo / Back Button -->
        <div class="flex items-center gap-4">
            <button id="back-btn" onclick="showMenu()" class="hidden text-slate-500 hover:text-indigo-600 transition-colors flex items-center gap-1 font-medium text-sm">
                <span class="material-symbols-outlined">arrow_back</span>
                Wybór Arkusza
            </button>
            <div id="logo-container" class="flex items-center gap-2 text-indigo-700">
                <span class="material-symbols-outlined text-3xl">school</span>
                <div>
                    <h1 class="font-bold leading-none text-lg">Matura Tutor</h1>
                    <p class="text-[10px] uppercase tracking-wider text-slate-500 font-semibold">Symulacja & Analiza AI (CKE 2025)</p>
                </div>
            </div>
        </div>

        <!-- Right Side: API Status -->
        <div class="flex items-center gap-3">
             <div class="flex items-center gap-2 bg-slate-50 px-3 py-1.5 rounded-full border border-slate-200 text-xs cursor-pointer hover:bg-slate-100 transition" onclick="document.getElementById('config-modal').showModal()">
                <div id="status-indicator" class="w-2 h-2 rounded-full bg-slate-400"></div>
                <span class="font-medium text-slate-500" id="status-text">API</span>
                <span class="material-symbols-outlined text-slate-400 text-sm">settings</span>
            </div>
        </div>
    </div>
</header>

<main class="flex-grow p-4 md:py-8 overflow-y-auto">

    <!-- === MENU VIEW === -->
    <div id="view-menu" class="max-w-6xl mx-auto fade-in">
        <div class="text-center mb-10 mt-4">
            <h2 class="text-3xl font-bold text-slate-900 mb-2">Wybierz Arkusz Egzaminacyjny</h2>
            <p class="text-slate-500">Dostępne są pełne arkusze CKE z oficjalnymi zasadami oceniania.</p>
        </div>

        <div class="grid md:grid-cols-3 gap-6" id="exam-grid">
            <!-- Cards generated by JS -->
        </div>
    </div>

    <!-- === EXAM VIEW === -->
    <div id="view-exam" class="hidden fade-in pb-20">
        <!-- Sticky Header Context -->
        <div id="exam-header-bar" class="max-w-4xl mx-auto mb-6 flex items-center justify-between px-2">
            <h2 id="exam-title-display" class="text-2xl font-bold text-slate-800">Matura</h2>
            <div class="text-sm text-slate-500 font-mono" id="exam-subtitle-display">Formuła 2023</div>
        </div>

        <div class="exam-sheet rounded-xl overflow-hidden border border-slate-200">
            
            <!-- SECTION 1: TEST -->
            <div class="bg-indigo-900 text-white px-8 py-4 flex justify-between items-center">
                <h3 class="font-bold text-lg">Część 1: Test</h3>
                <span class="text-indigo-200 text-sm">Język polski w użyciu / Historycznoliteracki</span>
            </div>

            <div class="p-8 md:p-12 space-y-10">
                <!-- Source Text Block (Język polski w użyciu) -->
                <div class="prose prose-slate max-w-none">
                    <div class="bg-slate-50 p-6 rounded-lg border-l-4 border-indigo-500 font-serif text-slate-800 leading-relaxed shadow-sm">
                        <h4 id="source-title" class="text-indigo-900 font-bold mb-4 not-prose">Teksty do zadań 1–5</h4>
                        <div id="source-content" class="text-sm md:text-base">
                            <!-- Injected via JS -->
                        </div>
                    </div>
                </div>

                <!-- Questions Container -->
                <div id="questions-list" class="space-y-8">
                    <!-- Injected via JS -->
                </div>
            </div>

            <!-- SECTION DIVIDER -->
            <div class="h-4 bg-slate-100 border-y border-slate-200 shadow-inner"></div>

            <!-- SECTION 2: ESSAY -->
            <div class="bg-indigo-900 text-white px-8 py-4 flex justify-between items-center">
                <h3 class="font-bold text-lg">Część 2: Wypracowanie</h3>
                <span class="text-indigo-200 text-sm">Min. 300 słów</span>
            </div>

            <div class="p-8 md:p-12 bg-white">
                <div class="mb-6">
                    <label class="block text-sm font-bold text-slate-700 mb-2">Wybierz temat wypracowania:</label>
                    <select id="essay-topic-selector" class="w-full bg-slate-50 border border-slate-300 rounded-lg p-3 text-slate-700 outline-none focus:ring-2 focus:ring-indigo-500 transition cursor-pointer">
                        <!-- Injected via JS -->
                    </select>
                </div>

                <div class="relative mb-6">
                    <textarea id="essay-editor" class="w-full min-h-[500px] p-6 bg-white border border-slate-200 rounded-lg font-serif text-lg leading-loose text-slate-800 outline-none focus:border-indigo-500 transition-colors resize-y shadow-inner placeholder:text-slate-300" placeholder="Tutaj wpisz treść swojego wypracowania..."></textarea>
                    <div id="essay-counter" class="absolute bottom-4 right-4 text-xs font-mono text-slate-400 bg-white/80 px-2 py-1 rounded border border-slate-100">0 słów</div>
                </div>

                <!-- Essay Action Bar -->
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 border-t border-slate-100 pt-6">
                    <button onclick="gradeEssay()" id="essay-submit-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white px-8 py-3 rounded-lg font-semibold shadow-lg shadow-indigo-200 transition-all flex items-center gap-2">
                        <span class="material-symbols-outlined">analytics</span>
                        Oceń Wypracowanie
                    </button>
                </div>

                <!-- Essay Feedback Area -->
                <div id="essay-feedback-area" class="hidden mt-8 bg-indigo-50 rounded-xl border border-indigo-100 p-6 animate-fade-in">
                    <h4 class="font-bold text-indigo-900 mb-4 flex items-center gap-2">
                        <span class="material-symbols-outlined">rate_review</span> Recenzja Egzaminatora (wg CKE)
                    </h4>
                    <div id="essay-feedback-content" class="markdown-body text-sm text-slate-700"></div>
                </div>
            </div>

        </div>
    </div>

</main>

<!-- CONFIG MODAL -->
<dialog id="config-modal" class="backdrop:bg-slate-900/50 rounded-2xl p-0 w-full max-w-md shadow-2xl open:animate-fade-in">
    <div class="p-6 border-b border-slate-100 flex justify-between items-center">
        <h3 class="text-lg font-bold text-slate-800">Ustawienia</h3>
        <button onclick="document.getElementById('config-modal').close()" class="text-slate-400 hover:text-slate-600">
            <span class="material-symbols-outlined">close</span>
        </button>
    </div>
    <div class="p-6 space-y-4">
        <div>
            <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Klucz Gemini API</label>
            <input type="password" id="api-key-input" class="w-full border border-slate-300 rounded-lg px-4 py-2.5 outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 transition-all font-mono" placeholder="AIzaSy...">
        </div>
        <div id="connection-msg" class="text-xs font-medium text-slate-500 h-5"></div>
    </div>
    <div class="p-4 bg-slate-50 border-t border-slate-100 flex justify-end gap-2">
        <button onclick="saveConfig()" class="px-6 py-2 text-sm font-semibold bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors shadow-sm">Zapisz</button>
    </div>
</dialog>

<script>
    // === STATE & CONFIG ===
    let API_KEY = ''; 
    const MODEL_NAME = 'gemini-2.5-flash';
    let currentExamData = null;

    // === DATA SOURCE ===
    const EXAMS = {
        '2025': {
            title: "Matura Maj 2025 (Oficjalny)",
            isBase: true,
            sourceText: `
                <h3 class="font-bold mb-4 text-xl">Tekst 1. Carl Sagan - Błękitna kropka</h3>
                <p>Nasi dalecy przodkowie, gdy obserwowali „gwiazdy”, zauważyli, że pięć z nich zachowuje się odmiennie niż pozostałe. W odróżnieniu od tak zwanych gwiazd stałych, wschodzących i zachodzących w niewzruszonym porządku, ruch tamtej piątki był dziwnie skomplikowany. Z upływem miesięcy „gwiazdy” wędrowały powoli wśród innych, niekiedy nawet zataczały pętle. Dzisiaj te ciała nazywamy planetami, od greckiego słowa planetes, które oznacza „wędrujący”. Wyobrażam sobie, że naszym przodkom taka cecha musiała się wydać bardzo bliska.</p>
                <p>Dziś wiemy, że planety są nie gwiazdami, lecz ciałami niebieskimi, które – tak jak Ziemia – krążą wokół Słońca, utrzymywane siłą jego grawitacji.</p>
                <p>Stany Zjednoczone i nieistniejący już Związek Radziecki dokonały czegoś zadziwiającego: badały z bliska owe świetlne plamki – od Merkurego do Saturna – które wprawiały naszych przodków w podziw i skłaniały do uprawiania nauki. Od pierwszych pomyślnych wypraw w kosmos statki kosmiczne z Ziemi przelatywały, okrążały lub lądowały na ponad siedemdziesięciu ciałach niebieskich. Rozpoczęliśmy wędrówkę pośród „wędrowców”. Znaleźliśmy rozległe wulkaniczne wzniesienia, przy których najwyższe góry na Ziemi wydają się karłami.</p>
                <p>Odkryliśmy cuda, o jakich naszym przodkom nawet się nie śniło, gdy zastanawiali się oni nad naturą światełek błądzących po nocnym niebie. Badamy początki naszej planety i początki nas samych. Dzięki temu, że odkryliśmy inne możliwości, to znaczy zmierzyliśmy się z odmiennymi losami globów mniej lub bardziej podobnych do naszego, zaczęliśmy lepiej rozumieć Ziemię. Każdy z tych światów jest na swój sposób piękny i pouczający. Niemniej, o ile nam wiadomo, są one zarazem, wszystkie bez wyjątku, puste i jałowe. Nigdzie nie czeka na nas „lepsze miejsce”, przynajmniej na razie.</p>
                <p>Obecnie przekroczyliśmy nieznacznie granice Układu Słonecznego, wysłaliśmy cztery statki kosmiczne ku gwiazdom. Neptun znajduje się milion razy dalej od Ziemi niż Nowy Jork od brzegów Bugu. W tych odległych światach, do których dotarliśmy, nie czekają jednak na nas dalecy krewni; nie ma tam ani istot ludzkich, ani – jak wiele na to wskazuje – śladów życia. Nie dysponujemy żadnymi listami od emigrantów, które mogłyby nam dopomóc w poznaniu nowych światów, a jedynie cieszymy się cyfrowymi danymi, przesłanymi nam z szybkością światła przez naszych precyzyjnych, automatycznych emisariuszy. Z tych informacji wynika, że te światy znacznie różnią się od naszego. Mimo to nadal poszukujemy ich mieszkańców – taka już nasza natura. Życie szuka innego życia.</p>
                <p>Nikogo na Ziemi, nawet najbogatszych ludzi, nie stać na razie na taką podróż. Nie możemy po prostu spakować się i wyruszyć na Marsa lub na Tytana. Nie widać też żadnych krótkoterminowych zysków, które mogłyby stanowić motywację dla prywatnych przedsiębiorców. Jeśli ludzie kiedykolwiek wyruszą ku tym światom, to dlatego, że jakieś państwo lub grupa państw uzna to za korzystne dla siebie lub dla całego rodzaju ludzkiego.</p>
                <p>W chwili obecnej istnieje wiele innych, pilnych spraw do załatwienia za pieniądze, które wydano by na wysyłanie ludzi w kosmos.</p>
                
                <hr class="my-8 border-slate-300">
                
                <h3 class="font-bold mb-4 text-xl">Tekst 2. Marta Trepczyńska - Ziemia 2.0 – poszukiwania nadal trwają</h3>
                <p>Czy ludzie mogą żyć na innej planecie niż Ziemia? W NASA od kilkudziesięciu lat trwają intensywne badania, mające na celu coraz głębszą eksplorację kosmosu i znalezienie odpowiedzi na pytanie, czy na jakiejkolwiek innej planecie mogły w przeszłości bądź mogą w przyszłości istnieć warunki dla przetrwania roślin i ludzi. O planach kolonizacji Marsa słyszeliśmy już niejeden raz. Teraz naukowcy idą o krok dalej. Czy możliwe jest, aby ludzie zamieszkali kiedykolwiek planetę Wenus? Ich nowe ustalenia nie wykluczają tego! Jest jednak kilka „ale”.</p>
                <p>Planetą najlepiej zbadaną przez człowieka jest oczywiście Mars, a o planach jego kolonizacji poważnie wypowiadali się wybitni naukowcy, np. Stephen Hawking. Badania potwierdzają istnienie na Marsie wody oraz prawdopodobnie innych substancji chemicznych niezbędnych do życia. W dalekiej przeszłości powierzchnię Marsa miał pokrywać ocean. Doba trwa tam niemal tyle samo, ile doba na Ziemi. Przeszkody dla pojawienia się tam ludzi to m.in. niebezpieczne promieniowanie kosmiczne oraz zbyt niskie temperatury dochodzące do nawet − 140 stopni Celsjusza. Jednak naukowcy nieustępliwie badają możliwość zasiedlenia Marsa. Ale to nie jest jedyna opcja na przyszłość.</p>
                <p>Jak twierdzą naukowcy, przyjazną planetą dla człowieka może być też Wenus, która jest drugą pod względem odległości od Słońca planetą Układu Słonecznego. Pod wieloma względami jest podobna do Ziemi, czasem jest nawet nazywana jej siostrzaną planetą. Ma podobną masę oraz rozmiar zbliżony do Ziemi. Jest też pokryta podobną skalistą strukturą. Tu podobieństwa się jednak kończą. Na powierzchni Wenus panuje piekielnie wysoka temperatura: 462 stopnie Celsjusza, a ciśnienie jest prawie sto razy wyższe od tego na Ziemi, czyli mniej więcej takie, jak kilometr pod powierzchnią oceanu. Jak więc mielibyśmy zasiedlić Wenus w takich warunkach? Planetę pokrywa gruba warstwa chmur i to właśnie w nich, około 50 km nad powierzchnią Wenus, naukowcy dopatrzyli się podobnych warunków jak na Ziemi. Zarówno temperatura, jak i ciśnienie są tam zbliżone do ziemskich. Naukowcy uważają, że można by stworzyć specjalną skorupę, która oddzieliłaby chmury od piekielnie gorącej powierzchni Wenus. Wtedy ludzie mogliby nawet wyjść z kapsuły kosmicznej. Oczywiście, potrzebowaliby specjalnych aparatów do oddychania, ponieważ planetę pokrywa w głównej mierze nie tlen, ale dwutlenek węgla.</p>
                <p>Według naukowców, możliwa byłaby też kolonizacja Księżyca. Ogromnym plusem jest jego odległość od Ziemi, co pozwoliłoby na szybkie i stosunkowo tanie przeloty ludzi oraz dostawy paliwa. Są również przeszkody. Dzień na Księżycu trwa dwa ziemskie tygodnie, podobnie – noc, a wówczas nie można korzystać z energii słonecznej.</p>
                <p>Badania przeprowadzone w latach 2015–2016 na Międzynarodowej Stacji Kosmicznej dowiodły, że człowiek nie może na razie na stałe mieszkać w kosmosie. W tym eksperymencie wzięli udział dwaj bracia Scottowie – pierwszy poleciał w kosmos, a drugi został na Ziemi, by można było porównywać ich stan zdrowia. To doświadczenie dowiodło, że przeszkodą do zamieszkania w kosmosie jest m.in. za bardzo pomniejszające się serce – po blisko roku trwania eksperymentu zmalało u pierwszego z braci o 27 procent, pomimo intensywnych ćwiczeń fizycznych.</p>
                <p>Jedno jest pewne: przy obecnym stanie wiedzy, a przede wszystkim przez warunki w kosmosie niesprzyjające ludziom, z planami kolonizacji planet musimy na razie „zejść na Ziemię”. Nauka robi jednak wszystko, aby pozwolić nam na przezwyciężenie fizycznych niedoskonałości i „odblokować” możliwość życia poza Ziemią. Od tego zależy w końcu przyszłość ludzkości.</p>
            `,
            questions: [
                { id: 1, points: 1, text: "Na podstawie tekstu Carla Sagana wyjaśnij sens zdania: 'Rozpoczęliśmy wędrówkę pośród wędrowców'.", rubric: "Zasady oceniania (CKE): 1 pkt – poprawne wyjaśnienie sensu zdania (planety jako 'wędrowcy', natura ludzka jako wędrowanie, rozpoczęcie lotów kosmicznych). 0 pkt – błąd lub brak." },
                { id: 2, points: 2, text: "Rozstrzygnij, czy w tekście Carla Sagana i w tekście Marty Trepczyńskiej jest mowa o takiej samej przyczynie zainteresowania kosmosem. W uzasadnieniu odpowiedzi odwołaj się do obu tekstów.", rubric: "Zasady oceniania (CKE): 2 pkt – Rozstrzygnięcie (NIE/TAK z zastrzeżeniem) + uzasadnienie z odwołaniem do obu tekstów (Sagan: ciekawość/życie, Trepczyńska: przetrwanie/warunki). 1 pkt – Rozstrzygnięcie + odwołanie do jednego tekstu." },
                { id: 3, points: 2, text: "Wyjaśnij, dlaczego zgodnie z tekstem Carla Sagana 'nie możemy po prostu spakować się i wyruszyć na Marsa'. Czy o takim samym ograniczeniu w eksplorowaniu kosmosu jest mowa w tekście Marty Trepczyńskiej?", rubric: "Zasady oceniania (CKE): 2 pkt – Wyjaśnienie wg Sagana (koszty/finanse) + rozstrzygnięcie i uzasadnienie wg Trepczyńskiej (warunki fizyczne/zdrowotne). 1 pkt – Tylko poprawne wyjaśnienie wg Sagana." },
                { id: 4, points: 1, text: "Oceń prawdziwość stwierdzeń (P/F):\n1. Czasowniki w 1. os. l.mn. u Sagana służą zmniejszeniu dystansu.\n2. W sformułowaniu Trepczyńskiej 'dzień na Księżycu trwa dwa ziemskie tygodnie' zastosowano przymiotnik wartościujący.", rubric: "Zasady oceniania (CKE): 1 pkt – PF (Prawda, Fałsz)." },
                { id: 5, points: 4, text: "Na podstawie obu tekstów napisz notatkę syntetyzującą na temat: 'odkrywanie kosmosu jako potrzeba człowieka'. (60-90 wyrazów)", rubric: "Zasady oceniania (CKE): Treść (3 pkt): A) Stanowiska obu autorów (Sagan: ciekawość, Trepczyńska: konieczność/przetrwanie), B) Zestawienie (punkty wspólne/rozbieżne), C) Spójność. Język (1 pkt): max 2 błędy. Długość: 60-90 słów." },
                { id: 6, points: 1, text: "Do których postaci mitologicznych nawiązują fragmenty?\n\nA. 'Jest pracowity, silny i wytrwały...' (A. Asnyk)\nB. 'Był taki młody nie rozumiał że skrzydła są tylko przenośnią...' (Z. Herbert)\n\nWybierz z: 1. Herakles, 2. Charon, 3. Syzyf, 4. Ikar.", rubric: "Zasady oceniania (CKE): 1 pkt – A1 (Herakles), B4 (Ikar)." },
                { id: 7, points: 2, text: "Zadanie 7.1. Wyjaśnij różnicę w postawie życiowej w 'Rozmowie Mistrza Polikarpa ze Śmiercią' a 'Wiośnie' J.A. Morsztyna.\n\nZadanie 7.2. Podaj nazwę epoki powstania 'Rozmowy...' i wykaż zgodność postawy ze światopoglądem epoki.", rubric: "7.1: 1 pkt – Różnica: Polikarp (asceza/memento mori) vs Morsztyn (carpe diem/korzystanie z życia). \n7.2: 1 pkt – Średniowiecze + teocentryzm/asceza/pamięć o śmierci." },
                { id: 8, points: 2, text: "Na podstawie 'Pieśni 14' (Księgi wtóre) Jana Kochanowskiego:\n8.1. Podaj dwa argumenty, którymi podmiot przekonuje rządzących do dbania o dobro społeczeństwa.\n8.2. Wypisz przykład epitetu z fragmentu 'Wy, mówię, którym ludzi paść poruczono'.", rubric: "8.1: 1 pkt – 2 argumenty (np. zastępują Boga, odpowiedzialność za upadek państwa). \n8.2: 1 pkt – 2 wiersze tabeli: Epitet + przykład (np. 'ludzką sprawiedliwość', 'stadem Bożym')." },
                { id: 9, points: 2, text: "Rozstrzygnij, czy obraz matki w 'Dziadach cz. III' (Pani Rollisonowa) jest podobny do obrazu matki w wierszu 'Stabat Mater' Józefa Wittlina. Sformułuj dwa argumenty.", rubric: "Zasady oceniania (CKE): 2 pkt – Rozstrzygnięcie + 2 argumenty (np. obie cierpiące, obie kochające LUB różnice: Rollisonowa aktywna/emocjonalna vs Wittlinowa bierna/zastygła)." },
                { id: 10, points: 2, text: "10.1. Komu ukazuje się Rycerz w 'Weselu' Wyspiańskiego? (Poeta, Dziad, Gospodarz, Dziennikarz)\n10.2. Wyjaśnij, czego symbolem jest Rycerz.", rubric: "10.1: 1 pkt – A (Poeta). \n10.2: 1 pkt – Symbol mocy, siły, dawnej potęgi Polski, walki z dekadentyzmem." },
                { id: 11, points: 1, text: "K.K. Baczyński 'Ten czas': Wyjaśnij sens sformułowania 'przejdziem w mit' w kontekście fragmentu wiersza.", rubric: "Zasady oceniania (CKE): 1 pkt – Staniemy się historią/legendą, zginiemy i zostanie tylko opowieść, bezradność wobec historii." },
                { id: 12, points: 2, text: "Rok 1984 (George Orwell): Wybierz dwa elementy graficzne z okładki (Wielki Brat, oko, tłum itp.) i wyjaśnij ich sens w kontekście problematyki utworu.", rubric: "Zasady oceniania (CKE): 2 pkt – 2 elementy (np. Oko = inwigilacja, Czerwień = totalitaryzm, Drut = zniewolenie, Tłum bez twarzy = utrata indywidualności)." },
                { id: 13, points: 1, text: "Sławomir Mrożek 'Tango' (Akt III, śmierć Eugenii): Wyjaśnij, na czym polega groteskowy charakter sytuacji. Zilustruj przykładem.", rubric: "Zasady oceniania (CKE): 1 pkt – Wyjaśnienie (nieadekwatność zachowania, banalizacja śmierci) + przykład (babcia wchodzi na katafalk jak do łóżka, Artur mówi 'dobra myśl')." },
                { id: 14, points: 2, text: "Zbigniew Herbert 'Stary Prometeusz': Czy postawa bohatera jest zgodna z mitologicznym pierwowzorem? Odwołaj się do wiersza i mitu.", rubric: "Zasady oceniania (CKE): 2 pkt – Rozstrzygnięcie + uzasadnienie (np. TAK: niezgoda na świat, ALE inna forma buntu; NIE: konformizm vs bunt, bierność vs aktywność)." }
            ],
            essayTopics: [
                "Temat 1. Źródło nadziei w czasach trudnych dla człowieka. (Lektura obowiązkowa + inny utwór + konteksty)",
                "Temat 2. Jak błędna ocena sytuacji wpływa na życie człowieka? (Lektura obowiązkowa + inny utwór + konteksty)"
            ]
        },
        '2024': {
            title: "Matura Maj 2024",
            isBase: true,
            questions: [
                { id: 16, points: 2, text: "Wyjaśnij rolę pamięci o Umschlagplatzu w życiu Marka Edelmana.", rubric: "2 pkt za rolę pamięci i odniesienie do tytułu." }
            ],
            essayTopics: ["Bunt i jego konsekwencje.", "Relacja z drugą osobą."]
        },
        '2023': {
            title: "Matura Maj 2023",
            isBase: true,
            questions: [
                { id: 10, points: 1, text: "Jaką postawę typową dla bohatera romantycznego przejawia Artur?", rubric: "1 pkt za wskazanie postawy i porównanie." }
            ],
            essayTopics: ["Człowiek – istota pełna sprzeczności.", "Bohaterstwo w oczach innych."]
        }
    };

    // === INITIALIZATION ===
    document.addEventListener('DOMContentLoaded', () => {
        const storedKey = localStorage.getItem('gemini_api_key');
        if (storedKey) {
            API_KEY = storedKey;
            document.getElementById('api-key-input').value = API_KEY;
            updateStatusUI(true);
        }
        
        renderMenu();
        
        // Auto-resize
        const editor = document.getElementById('essay-editor');
        if (editor) {
            editor.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = (this.scrollHeight) + 'px';
                const count = this.value.trim().split(/\s+/).filter(w => w.length > 0).length;
                document.getElementById('essay-counter').innerText = `${count} słów`;
            });
        }
    });

    // === CORE UI FUNCTIONS ===
    
    function renderMenu() {
        const grid = document.getElementById('exam-grid');
        grid.innerHTML = '';
        
        Object.keys(EXAMS).forEach(key => {
            const exam = EXAMS[key];
            const isImported = !exam.isBase;
            const colorClass = key === '2025' ? 'indigo' : (key === '2024' ? 'blue' : (isImported ? 'purple' : 'emerald'));
            const icon = isImported ? 'folder_open' : 'history_edu';
            
            grid.innerHTML += `
                <div onclick="loadExam('${key}')" class="group bg-white rounded-2xl shadow-sm border border-slate-200 p-6 cursor-pointer hover:shadow-xl hover:-translate-y-1 transition-all relative overflow-hidden flex flex-col h-full">
                    <div class="absolute -right-6 -top-6 w-24 h-24 bg-${colorClass}-50 rounded-full group-hover:bg-${colorClass}-100 transition-colors"></div>
                    <div class="relative z-10 flex flex-col h-full">
                        <div class="flex items-center justify-between mb-4">
                            <span class="bg-${colorClass}-600 text-white text-[10px] font-bold px-2 py-1 rounded-full uppercase tracking-wide">${isImported ? 'Własny' : 'Oficjalny'}</span>
                            <span class="material-symbols-outlined text-${colorClass}-300 text-3xl">${icon}</span>
                        </div>
                        <h3 class="text-lg font-bold text-slate-800 mb-2">${exam.title}</h3>
                        <ul class="text-xs text-slate-500 space-y-1 mb-4 flex-grow">
                            <li class="flex items-center gap-2"><span class="material-symbols-outlined text-sm">list</span> ${exam.questions.length} Pytań</li>
                            <li class="flex items-center gap-2"><span class="material-symbols-outlined text-sm">edit</span> ${exam.essayTopics.length} Tematy</li>
                        </ul>
                        <span class="text-${colorClass}-600 font-semibold text-xs flex items-center gap-1 mt-auto">
                            Rozwiąż <span class="material-symbols-outlined text-sm">arrow_forward</span>
                        </span>
                    </div>
                </div>
            `;
        });
    }

    function loadExam(key) {
        currentExamData = EXAMS[key];
        if(!currentExamData) return;

        document.getElementById('view-menu').classList.add('hidden');
        document.getElementById('view-exam').classList.remove('hidden');
        document.getElementById('back-btn').classList.remove('hidden');
        document.getElementById('logo-container').classList.add('hidden');

        document.getElementById('exam-title-display').innerText = currentExamData.title;
        
        // Show/Hide Source Text Block
        const sourceBlock = document.querySelector('.prose');
        if (currentExamData.sourceText) {
            sourceBlock.classList.remove('hidden');
            document.getElementById('source-content').innerHTML = currentExamData.sourceText;
        } else {
            sourceBlock.classList.add('hidden');
        }
        
        // Populate Questions
        const qList = document.getElementById('questions-list');
        qList.innerHTML = '';
        currentExamData.questions.forEach(q => {
            qList.innerHTML += `
                <div class="group border border-slate-200 rounded-lg p-6 hover:border-indigo-300 transition-colors bg-white shadow-sm">
                    <div class="flex justify-between items-start mb-4">
                        <span class="bg-slate-100 text-slate-600 font-bold text-xs px-2 py-1 rounded">ZADANIE ${q.id}</span>
                        <span class="text-xs font-mono text-slate-400">0-${q.points} pkt</span>
                    </div>
                    <p class="font-medium text-slate-800 mb-4 leading-relaxed whitespace-pre-wrap">${q.text}</p>
                    <textarea id="answer-${q.id}" class="w-full bg-slate-50 border border-slate-200 rounded-md p-3 text-sm focus:bg-white focus:ring-2 focus:ring-indigo-500 outline-none transition-all placeholder:text-slate-400 min-h-[100px]" placeholder="Wpisz odpowiedź..."></textarea>
                    <div id="feedback-${q.id}" class="hidden mt-4 pt-4 border-t border-indigo-100 bg-indigo-50/50 p-4 rounded-lg text-sm markdown-body"></div>
                    <div class="mt-4 flex justify-end">
                        <button onclick="checkQuestion(${q.id})" id="btn-${q.id}" class="text-sm font-semibold text-white bg-slate-800 hover:bg-slate-900 px-4 py-2 rounded-lg transition-colors flex items-center gap-2">
                            <span class="material-symbols-outlined text-sm">check</span> Sprawdź
                        </button>
                    </div>
                </div>
            `;
        });

        // Populate Essay Topics
        const select = document.getElementById('essay-topic-selector');
        select.innerHTML = '<option value="" disabled selected>-- Wybierz temat --</option>';
        currentExamData.essayTopics.forEach((t, i) => {
            select.innerHTML += `<option value="${t}">Temat ${i+1}: ${t.substring(0,100)}...</option>`;
        });
        
        document.getElementById('essay-editor').value = '';
        document.getElementById('essay-feedback-area').classList.add('hidden');
        document.querySelector('main').scrollTop = 0;
    }

    function showMenu() {
        document.getElementById('view-menu').classList.remove('hidden');
        document.getElementById('view-exam').classList.add('hidden');
        document.getElementById('back-btn').classList.add('hidden');
        document.getElementById('logo-container').classList.remove('hidden');
    }

    // === API LOGIC ===
    function saveConfig() {
        const key = document.getElementById('api-key-input').value.trim();
        if(!key) { alert("Brak klucza."); return; }
        API_KEY = key;
        localStorage.setItem('gemini_api_key', API_KEY);
        updateStatusUI(true);
        document.getElementById('config-modal').close();
    }

    function updateStatusUI(isConnected) {
        const dot = document.getElementById('status-indicator');
        const text = document.getElementById('status-text');
        dot.className = isConnected ? "w-2 h-2 rounded-full bg-green-500" : "w-2 h-2 rounded-full bg-slate-400";
        text.className = isConnected ? "font-medium text-indigo-600" : "font-medium text-slate-500";
    }

    async function callGemini(prompt) {
        if (!API_KEY) { document.getElementById('config-modal').showModal(); throw new Error("Klucz wymagany"); }
        try {
            const resp = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${API_KEY}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
            });
            const data = await resp.json();
            if(!resp.ok) throw new Error(data.error?.message || "Błąd API");
            return data.candidates[0].content.parts[0].text;
        } catch(e) { throw e; }
    }

    async function checkQuestion(qId) {
        const ans = document.getElementById(`answer-${qId}`).value;
        if(!ans) return;
        const btn = document.getElementById(`btn-${qId}`);
        const fb = document.getElementById(`feedback-${qId}`);
        
        btn.disabled = true;
        btn.innerHTML = `<span class="loader"></span>`;
        fb.classList.add('hidden');

        const q = currentExamData.questions.find(x => x.id == qId);
        
        const prompt = `Jesteś oficjalnym egzaminatorem CKE. Sprawdź zadanie maturalne zgodnie z podanym kluczem.

        Pytanie: ${q.text}
        
        OFICJALNE KRYTERIA OCENIANIA (KLUCZ):
        ${q.rubric || "Brak szczegółowego klucza. Oceń poprawność merytoryczną i logiczną."}

        Odpowiedź ucznia: "${ans}"

        ZADANIE DLA CIEBIE:
        1. Oceń odpowiedź (0-${q.points} pkt).
        2. W uzasadnieniu odnieś się BEZPOŚREDNIO do klucza (np. "Odpowiedź zawiera element X wymagany w kluczu").
        3. Jeśli odpowiedź jest niepełna, wskaż czego zabrakło.
        4. Bądź surowy i precyzyjny.
        Format odpowiedzi: Markdown.`;

        try {
            const txt = await callGemini(prompt);
            fb.innerHTML = marked.parse(txt);
            fb.classList.remove('hidden');
        } catch(e) {
            alert(e.message);
        } finally {
            btn.disabled = false;
            btn.innerHTML = `<span class="material-symbols-outlined text-sm">check</span> Sprawdź`;
        }
    }

    async function gradeEssay() {
        const content = document.getElementById('essay-editor').value;
        const topic = document.getElementById('essay-topic-selector').value;
        if(content.length < 50) { alert("Za krótko."); return; }

        const btn = document.getElementById('essay-submit-btn');
        const area = document.getElementById('essay-feedback-area');
        const contentArea = document.getElementById('essay-feedback-content');

        btn.disabled = true;
        btn.innerHTML = `<span class="loader"></span> Analiza wg CKE...`;
        area.classList.add('hidden');

        // OFFICIAL CKE ESSAY PROMPT
        const prompt = `Jesteś egzaminatorem CKE. Oceń wypracowanie maturalne (Formuła 2023) zgodnie z oficjalnymi zasadami oceniania z 2025 roku.

        TEMAT: ${topic || "Własny"}
        TREŚĆ UCZNIA:
        "${content}"

        ZASADY OCENIANIA (Skrót):
        1. SPEŁNIENIE FORMALNYCH WARUNKÓW (0-1 pkt):
           - Brak błędu kardynalnego?
           - Odwołanie do lektury obowiązkowej?
           - Praca na temat?
           - Forma argumentacyjna?
           (Jeśli 0 pkt tutaj -> cała praca 0 pkt).

        2. KOMPETENCJE LITERACKIE I KULTUROWE (0-16 pkt):
           - Funkcjonalne wykorzystanie 2 utworów (lektura + inny).
           - Funkcjonalne wykorzystanie 2 kontekstów.
           - Jakość argumentacji (bogata/zadowalająca/powierzchowna).
           - Błędy rzeczowe (odejmują punkty).

        3. STRUKTURA (0-3 pkt):
           - Podział logiczny (wstęp, rozwinięcie, zakończenie).
           - Spójne akapity.

        4. SPÓJNOŚĆ (0-3 pkt):
           - Logika wewnątrz akapitów i między nimi.

        5. STYL (0-1 pkt):
           - Stosowny do sytuacji egzaminacyjnej.

        6. JĘZYK (0-7 pkt):
           - Zakres słownictwa i poprawność (błędy fleksyjne, składniowe, leksykalne).

        7. ORTOGRAFIA (0-2 pkt):
           - 0-1 błąd = 2 pkt, 2-4 błędy = 1 pkt, 5+ = 0 pkt.

        8. INTERPUNKCJA (0-2 pkt):
           - 0-8 błędów = 2 pkt, 9-16 = 1 pkt, 17+ = 0 pkt.

        ZADANIE:
        Sporządź tabelę oceniania w Markdown. Dla każdego kryterium podaj liczbę punktów i KRÓTKIE uzasadnienie (np. "Błąd rzeczowy w nazwisku", "Brak akapitów").
        Podsumuj sumę punktów (Max 35).
        Na końcu napisz krótką recenzję opisową dla ucznia (co poprawić).`;

        try {
            const txt = await callGemini(prompt);
            contentArea.innerHTML = marked.parse(txt);
            area.classList.remove('hidden');
            area.scrollIntoView({behavior:"smooth"});
        } catch(e) {
            alert(e.message);
        } finally {
            btn.disabled = false;
            btn.innerHTML = `<span class="material-symbols-outlined">analytics</span> Oceń Wypracowanie`;
        }
    }
</script>

</body>
</html>
